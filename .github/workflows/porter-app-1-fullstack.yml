on:
  push:
    branches:
      - main

name: Porter Test - Customer Equivalent (Fixed)
jobs:
  porter-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2.3.4

    - name: Set Github tag
      id: vars
      run: echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"

    - name: Disable containerd image store
      shell: bash
      run: |
        DAEMON_JSON="/etc/docker/daemon.json"
        if [ -f "$DAEMON_JSON" ]; then
          jq '. + {"features": {"containerd-snapshotter": false}}' "$DAEMON_JSON" > /tmp/daemon.json
        else
          echo '{"features": {"containerd-snapshotter": false}}' > /tmp/daemon.json
        fi
        sudo mv /tmp/daemon.json "$DAEMON_JSON"
        sudo systemctl restart docker

    - name: Build fullstack
      uses: porter-dev/porter-cli-action@v0.1.1
      with:
        command: update build --app fullstack --tag ${{ steps.vars.outputs.sha_short }}
      env:
        PORTER_HOST: https://mauricio.withporter.run
        PORTER_CLUSTER: "1"
        PORTER_PROJECT: "1"
        PORTER_TOKEN: ${{ secrets.PORTER_APP_1_988596736 }}
        
    - name: Push fullstack
      uses: porter-dev/porter-cli-action@v0.1.1
      with:
        command: update push --app fullstack --tag ${{ steps.vars.outputs.sha_short }}
      env:
        PORTER_HOST: https://mauricio.withporter.run
        PORTER_CLUSTER: "1"
        PORTER_PROJECT: "1"
        PORTER_TOKEN: ${{ secrets.PORTER_APP_1_988596736 }}

    # I have removed the "Update image for release" and "Run release job" steps 
    # because you do not have a resource named "release" in your Porter project.

    - name: Update the config for fullstack
      uses: porter-dev/porter-cli-action@v0.1.1
      with:
        command: update config --app fullstack --tag ${{ steps.vars.outputs.sha_short }}
      env:
        PORTER_HOST: https://mauricio.withporter.run
        PORTER_CLUSTER: "1"
        PORTER_PROJECT: "1"
        PORTER_TOKEN: ${{ secrets.PORTER_APP_1_988596736 }}
        PORTER_DEPLOYMENT_TARGET_ID: e1c624cc-6272-41a3-9cea-8c887a1efbcf
